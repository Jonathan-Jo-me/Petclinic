pipeline {
  agent any

  environment {
    // Error: Reference to a non-existent credential ID
    GIT_CREDS = credentials('non-existent-git-creds')
  }

  stages {
    stage('Checkout') {
      steps {
        // Error: Wrong repository URL (will fail)
        git credentialsId: "${env.GIT_CREDS}", url: 'https://github.com/invalid/repo.git'
      }
    }
    stage('Build') {
      steps {
        // Error: Non-existent build tool
        sh 'not-a-build-tool build'
      }
    }
    stage('Test') {
      steps {
        // Error: Reference to a missing script
        sh './run_tests.sh'
      }
    }
    stage('Deploy') {
      steps {
        // Error: Deploy script with typo in filename
        sh 'bash deploy-prod.shh'
      }
    }
  }

  post {
    failure {
      script {
        try {
          echo "Collecting pipeline logs..."

          // Error: Using a restricted method (may not work in sandboxed Jenkins)
          def log = currentBuild.rawBuild.getLog(1000)
          def logText = log.join("\n")

          // Error: Sending logs to an insecure HTTP endpoint
          def payload = groovy.json.JsonOutput.toJson([log: logText])
          def response = httpRequest(
            httpMode: 'POST',
            url: 'http://example.com/webhook',
            contentType: 'APPLICATION_JSON',
            requestBody: payload
          )

          echo "Webhook response: ${response.status} - ${response.content}"
        } catch (Exception e) {
          echo "ERROR sending webhook: ${e.message}"
        }
      }
    }
  }
}
